// simulation speed toggling
function initSpeedToggle(app) {
	app.renderer.renderer.view.addEventListener('mousedown', app.toggleSimSpeedForwarder.bind(app));
	app.renderer.renderer.view.addEventListener('touchstart', app.toggleSimSpeedForwarder.bind(app));
}

function toggleSimSpeed(app) {
	if (m_sim_intv_fps == 60) {
		m_sim_intv_fps = 1000;
		m_render_fps = 10;
	}
	else {
		m_sim_intv_fps = 60;
		m_render_fps = 30;
	}
	
	console.log("sim fps: " + m_sim_intv_fps)
	console.log("render fps: " + m_render_fps);

	setStepIntv(app);
	setAnimIntv(app);
}


// scroll wheel - zoom camera in and out
function setMouseZoomEvent(app) {
	app.renderer.renderer.view.addEventListener('wheel', function(event) {
		event.preventDefault();

		if((event.deltaX + event.deltaY + event.deltaZ) > 0) {
			if(zoom > 1)
				zoom -= 1;
		} else
			zoom += 1;

		canvasResize(app);
	});
}


// canvas resizing
function setResizeEvents(app) {
	window.addEventListener('resize', app.canvasResizeForwarder.bind(app));
	window.addEventListener('orientationchange', app.orientationChangeForwarder.bind(app));
}

function canvasResize(app) {
	var w = window.innerWidth;
	var h = window.innerHeight;

	app.renderer.renderer.resize(w, h);

	app.renderer.stage.scale.x = zoom*w/1600;
	app.renderer.stage.scale.y = -zoom*h/900;

	if(app.renderer.stage.scale.x > (-app.renderer.stage.scale.y))
		app.renderer.stage.scale.x = -app.renderer.stage.scale.y;
	else
		app.renderer.stage.scale.y = -app.renderer.stage.scale.x;

	renderUpdate(app);
}

function orientationChange(app) {
	window.scrollTo(0, 0);
	resize(app);
	window.scrollTo(0, 0);
	window.scrollTo(0, 0);
}


function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};


// save and load pretrained network
function setCopyLoadEvents(app) {
	window.addEventListener("copy", app.saveNetForwarder.bind(app));
	window.addEventListener("paste", app.loadNetForwarder.bind(app));
	parent.document.getElementById("pretrained").addEventListener("click", app.loadPretrainedNetForwarder.bind(app));
}

function saveNet(e, app) {
	e.preventDefault();

	const net = app.gen_algo.population[0].net.save();

	console.log(net);
	e.clipboardData.setData('text/plain', net);
}

function loadNet(e, app) {
	e.preventDefault();

	const net_obj = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));

	resetCars(app);

	app.gen_algo.population[0].net.load(net_obj);
	console.log("neural net restored");
}

function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":13,"hidden_layers":[{"inputs":13,"neurons":[{"weights":[0.3080496466531555,0.9202445118915275,0.6870112947075626,1.1819115520098529,-0.03249122443818066,0.6104326395792529,0.2825410877711758,-0.4737825279193642,1.0674552228304066,0.41897026740915533,-0.8096220103989225,0.7490739609262126,-1.3605657189172387],"bias":-0.17250976732992107},{"weights":[-1.8350847116511486,0.790315383439103,0.48858489200624006,0.39470354164520066,-0.4839445552184249,0.5413658892616161,0.08166463381243183,0.05246174363155309,-0.6027472025229548,-0.48430380257005173,-0.5231388888045876,-0.2160792043660839,0.7058521149305631],"bias":0.3119576922559236},{"weights":[0.6781404778005973,0.35324235690220923,-0.06334445746496617,-0.6110258193362992,0.8780787553881272,-0.5039374515834376,0.3172168870027055,-0.055967015140373944,-0.5550504481345773,-0.010008413265278376,0.4143277880412672,0.8093069950903388,1.3388957592790687],"bias":-0.1886180162590821},{"weights":[-0.45426007744264013,-0.04682520998922798,-0.9091741878290902,-1.083370928299678,-0.24354316474503568,0.3381633453116671,1.3656507851531465,-0.3654135497395189,-0.7934416820936877,0.03945184321617899,-0.6927861099393955,-0.07153561025424261,0.45886579288835777],"bias":0.09590330988877749},{"weights":[-1.181999975032287,-0.5068150811970589,0.8474850235904965,0.3251157318166397,0.5652965742774303,-0.10449863559933137,-0.2372419212265015,-1.0645919714734147,-0.7109523049145144,-0.9627232028704692,-0.6497542167417152,-0.007432592175678668,0.564319516804785],"bias":-0.04604509839238633},{"weights":[0.05825158385393503,0.10127684270480077,-0.6060604656043338,-0.17950432841983616,0.9449946309377802,-0.5006520170099789,0.30690151231253227,0.5951746826051959,-0.40520583742157346,0.3139513431071228,-1.0906858349233393,-0.8982119273552924,0.4588157870195245],"bias":0.9292320987871898},{"weights":[0.3562447368014757,0.3043854983048735,1.0525323638427029,0.33416330754975254,0.22880042153100275,0.05799802593004341,0.5794637546703335,-0.6464960415478253,1.0833601066733503,-1.1148915037354814,-0.3695048360006437,0.04009577028463837,-0.8784482022924676],"bias":0.39084968878278115},{"weights":[-1.124581863526774,0.6350151992419059,0.4240566798054186,-0.6654247950641566,0.8881256938926096,0.15529217451496596,-0.8574151474281151,0.04840154380582545,0.8897218920883265,1.0462070825482168,-0.22015469827944845,0.28994696335208797,-0.007834885619646903],"bias":-0.04639013556264559},{"weights":[-0.7324128380359696,0.655598749830521,0.825194817996159,-0.35491349326358274,0.0008147813256581954,-0.003549862301850712,-0.466406826596361,-0.24917374747757765,-0.23494047712563537,1.0482201945767373,1.2300512347708326,0.632343359315414,-0.6173435750887615],"bias":0.24356672241913974},{"weights":[-0.7346952864132629,0.3349588136812244,0.8111287757388197,-0.21318786413900237,0.2956190568024508,0.7622475634168184,1.2153354049784135,-0.3279427097493991,0.12771755346577168,-1.2236332019054585,0.9276119956317672,0.07561639299213227,0.09317828905290874],"bias":0.1329534400735449}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.5040163325421406,-0.6794678284910222,0.0760243632109475,0.04461193601909417,0.3962186942794824,-1.334215904197526,-0.8978597496695676,0.07107800906408518,0.9672489148884394,0.2792320292073663],"bias":0.14268116520654572},{"weights":[0.6067382272234965,0.7656000640394431,-1.2701891478331604,0.3587190912883502,-0.412355621413209,0.001969140333494178,-0.803140700680166,0.27359162153479044,0.6723944827232077,0.21571883419558496],"bias":0},{"weights":[-0.9984549962626804,-1.1000589879367948,-0.0779230567256391,0.05021794531283118,0.16588479839471712,-0.5033579648238424,-0.25017778527016715,-1.122384281044737,0.12954725473703801,-0.29920530124578476],"bias":-0.26954136619775715},{"weights":[-0.8238905130559906,-0.2631043736358033,0.804471360171708,0.7261398132609787,0.699150056528163,-0.3222876389337159,-0.7229702473388813,-1.3263449860541086,-0.5788247399746888,0.24563889855321525],"bias":0.08839047514399866}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};