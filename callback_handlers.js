// simulation speed toggling
function initSpeedToggle(app) {
	app.renderer.renderer.view.addEventListener('mousedown', app.toggleSimSpeedForwarder.bind(app));
	app.renderer.renderer.view.addEventListener('touchstart', app.toggleSimSpeedForwarder.bind(app));
}

function toggleSimSpeed(app) {
	if (m_sim_intv_fps == 60) {
		m_sim_intv_fps = 1000;
		m_render_fps = 10;
	}
	else {
		m_sim_intv_fps = 60;
		m_render_fps = 30;
	}
	
	console.log("sim fps: " + m_sim_intv_fps)
	console.log("render fps: " + m_render_fps);

	setStepIntv(app);
	setAnimIntv(app);
}


// scroll wheel - zoom camera in and out
function setMouseZoomEvent(app) {
	app.renderer.renderer.view.addEventListener('wheel', function(event) {
		event.preventDefault();

		if((event.deltaX + event.deltaY + event.deltaZ) > 0) {
			if(zoom > 1)
				zoom -= 1;
		} else
			zoom += 1;

		canvasResize(app);
	});
}


// canvas resizing
function setResizeEvents(app) {
	window.addEventListener('resize', app.canvasResizeForwarder.bind(app));
	window.addEventListener('orientationchange', app.orientationChangeForwarder.bind(app));
}

function canvasResize(app) {
	var w = window.innerWidth;
	var h = window.innerHeight;

	app.renderer.renderer.resize(w, h);

	app.renderer.stage.scale.x = zoom*w/1600;
	app.renderer.stage.scale.y = -zoom*h/900;

	if(app.renderer.stage.scale.x > (-app.renderer.stage.scale.y))
		app.renderer.stage.scale.x = -app.renderer.stage.scale.y;
	else
		app.renderer.stage.scale.y = -app.renderer.stage.scale.x;

	renderUpdate(app);
}

function orientationChange(app) {
	window.scrollTo(0, 0);
	resize(app);
	window.scrollTo(0, 0);
	window.scrollTo(0, 0);
}


function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};


// save and load pretrained network
function setCopyLoadEvents(app) {
	window.addEventListener("copy", app.saveNetForwarder.bind(app));
	window.addEventListener("paste", app.loadNetForwarder.bind(app));
	parent.document.getElementById("pretrained").addEventListener("click", app.loadPretrainedNetForwarder.bind(app));
}

function saveNet(e, app) {
	e.preventDefault();

	const net = app.gen_algo.population[0].net.save();

	console.log(net);
	e.clipboardData.setData('text/plain', net);
}

function loadNet(e, app) {
	e.preventDefault();

	const net_obj = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));

	resetCars(app);

	app.gen_algo.population[0].net.load(net_obj);
	console.log("neural net restored");
}

function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};