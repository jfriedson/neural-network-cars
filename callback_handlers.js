// simulation speed toggling
function initSpeedToggle(app) {
	app.renderer.renderer.view.addEventListener('mousedown', app.toggleSimSpeedForwarder.bind(app));
	app.renderer.renderer.view.addEventListener('touchstart', app.toggleSimSpeedForwarder.bind(app));
}

function toggleSimSpeed(app) {
	if (m_sim_intv_fps == 60) {
		m_sim_intv_fps = 1000;
		m_render_fps = 10;
	}
	else {
		m_sim_intv_fps = 60;
		m_render_fps = 30;
	}
	
	console.log("sim fps: " + m_sim_intv_fps)
	console.log("render fps: " + m_render_fps);

	setStepIntv(app);
	setAnimIntv(app);
}


// scroll wheel - zoom camera in and out
function setMouseZoomEvent(app) {
	app.renderer.renderer.view.addEventListener('wheel', function(event) {
		event.preventDefault();

		if((event.deltaX + event.deltaY + event.deltaZ) > 0) {
			if(zoom > 1)
				zoom -= 1;
		} else
			zoom += 1;

		canvasResize(app);
	});
}


// canvas resizing
function setResizeEvents(app) {
	window.addEventListener('resize', app.canvasResizeForwarder.bind(app));
	window.addEventListener('orientationchange', app.orientationChangeForwarder.bind(app));
}

function canvasResize(app) {
	var w = window.innerWidth;
	var h = window.innerHeight;

	app.renderer.renderer.resize(w, h);

	app.renderer.stage.scale.x = zoom*w/1600;
	app.renderer.stage.scale.y = -zoom*h/900;

	if(app.renderer.stage.scale.x > (-app.renderer.stage.scale.y))
		app.renderer.stage.scale.x = -app.renderer.stage.scale.y;
	else
		app.renderer.stage.scale.y = -app.renderer.stage.scale.x;

	renderUpdate(app);
}

function orientationChange(app) {
	window.scrollTo(0, 0);
	resize(app);
	window.scrollTo(0, 0);
	window.scrollTo(0, 0);
}


function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};


// save and load pretrained network
function setCopyLoadEvents(app) {
	window.addEventListener("copy", app.saveNetForwarder.bind(app));
	window.addEventListener("paste", app.loadNetForwarder.bind(app));
	parent.document.getElementById("pretrained").addEventListener("click", app.loadPretrainedNetForwarder.bind(app));
}

function saveNet(e, app) {
	e.preventDefault();

	const net = app.gen_algo.population[0].net.save();

	console.log(net);
	e.clipboardData.setData('text/plain', net);
}

function loadNet(e, app) {
	e.preventDefault();

	const net_obj = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));

	resetCars(app);

	app.gen_algo.population[0].net.load(net_obj);
	console.log("neural net restored");
}

function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":13,"hidden_layers":[{"inputs":13,"neurons":[{"weights":[1.2367932623617948,0.8047114156301725,0.6870112947075626,1.1037712470245795,0.10390063287593986,0.7866936443503735,0.23627350269633068,-0.2224259076903503,1.0115609289938254,-0.46171639544468346,-0.969108178963876,0.856317801734085,-1.1769214904292633],"bias":-0.0752959642237635},{"weights":[-1.912461163497226,0.7818966994738159,0.313274191239586,0.5435855750639195,-0.5031428233883254,0.07036716366246293,0.3414389149979448,0.1882449109492838,-0.7334220195659038,-0.49911871989489187,-0.3846085075073971,-0.27665279516985797,0.7586557694065069],"bias":0.2641643249401383},{"weights":[0.7987025954833802,0.10041257557767846,-0.1543417379632197,0.4345420820361824,0.5049046858499009,-1.2372745408147536,0.6196837212780868,-0.1591723159130183,-0.4150507150368289,-0.058185869581920784,-0.4319824480595601,0.8902855473791697,1.4204227844826172],"bias":-0.17062982588624784},{"weights":[-0.36950570941609984,-0.08280357543549162,-0.4372458549331678,-1.0975328117861964,-0.1503747624108891,-0.7255322401507635,1.3656507851531465,-0.6031296153447231,-1.2174886673271885,-0.2649808161071207,-0.4228981551707554,-0.030690196181252072,0.04280320505212941],"bias":-0.009920651400882316},{"weights":[-0.9302275702219509,-0.47126631517265805,-0.1914286072682942,0.447145074679118,0.6830178816421557,0.8026855534941026,-0.1779615025898305,-0.9584399728603976,-0.6571801695976792,-0.8859732896324827,-0.606868085239365,-0.002356424224334519,-0.5870308896451412],"bias":0.23470997455612258},{"weights":[0.08578878002035345,0.022478177773499086,0.3307902190773755,-0.19407970892751977,-1.2095855190280531,0.5520740625346336,0.5416041511810533,0.5951746826051959,-0.2856460544064834,0.2681547807992085,-1.0044599410727566,-0.8370767706108632,0.3429250909249196],"bias":0.7141977904301211},{"weights":[0.437374019530869,0.3043854983048735,0.8665285758887843,0.31151619086227533,0.18904717967296786,-0.08087075150552486,0.3297651648961639,-1.0515120277803236,1.2060862621829016,-0.9297119082167407,-0.7474621520040609,0.11268782732230877,-0.8784482022924676],"bias":0.5612748628366392},{"weights":[-0.9803064983450182,-0.05375823578865316,0.33393949842096465,-0.2062564586192228,0.6214465072919502,0.15162594447015504,-0.8059608993453741,0.0063159306648460575,0.6374432988405696,1.0748244188150151,-0.1456973812957315,0.46688809978800655,0.21100194888761212],"bias":0.32534640826004124},{"weights":[-0.17296997141254244,0.6131152182081943,-0.6547819149186247,-0.38685317575831485,-0.037535260335188905,-0.0018503977794649576,-0.3004516359501056,-0.3543373556467659,-0.3338846009651205,1.1823711188604256,0.9936701832480616,0.632343359315414,0.02662943299975562],"bias":0.42051170648163083},{"weights":[-1.0922136190479235,0.2757978126148682,0.8231407265984134,-0.11386084416050316,0.0967935871710644,-1.18149362626234,1.2229304579289424,-0.19939537473509503,0.29437725054281727,-1.2899006857994462,1.050107598639289,-0.03861459278267705,0.1316942327535519],"bias":0.5883330635069153}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.46499586766713197,-0.8633157109164551,0.11966646083236715,0.04461193601909417,0.4740865013930026,-1.3174077766976973,-0.9741095301049678,0.09448891719107749,0.9267715696380825,0.4369872023277066],"bias":0.2589886901006339},{"weights":[0.6171906927795073,0.6000990124841928,-1.1009342548161698,0.27138016640643886,-0.3023384404595387,-0.16352205976051815,-0.9749118973796331,0.0654114814612059,0.5938151528367427,0.33988536314136214],"bias":0.23909166217594235},{"weights":[-0.9109641669492313,-1.1865191578966454,0.00973974245125446,0.0184164433570619,0.007072436753728234,-0.48596965296858957,-0.19298713648194532,-1.122384281044737,-0.5232634363784887,0.5786951881896859],"bias":-0.04913463946471035},{"weights":[-0.03552860042306141,-0.04558896984910371,0.8150147342370455,-0.019989116090146877,-0.4380549705322984,-0.3427591741989711,-0.6823698097516607,-1.3995795857966131,-0.5788247399746888,-0.34750603246303613],"bias":0.2615977954972201}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};