// simulation speed toggling
function initSpeedToggle(app) {
	app.renderer.renderer.view.addEventListener('mousedown', app.toggleSimSpeedForwarder.bind(app));
	app.renderer.renderer.view.addEventListener('touchstart', app.toggleSimSpeedForwarder.bind(app));
}

function toggleSimSpeed(app) {
	if (m_sim_intv_fps == 60) {
		m_sim_intv_fps = 1000;
		m_render_fps = 10;
	}
	else {
		m_sim_intv_fps = 60;
		m_render_fps = 30;
	}
	
	console.log("sim fps: " + m_sim_intv_fps)
	console.log("render fps: " + m_render_fps);

	setStepIntv(app);
	setAnimIntv(app);
}


// scroll wheel - zoom camera in and out
function setMouseZoomEvent(app) {
	app.renderer.renderer.view.addEventListener('wheel', function(event) {
		event.preventDefault();

		if((event.deltaX + event.deltaY + event.deltaZ) > 0) {
			if(zoom > 1)
				zoom -= 1;
		} else
			zoom += 1;

		canvasResize(app);
	});
}


// canvas resizing
function setResizeEvents(app) {
	window.addEventListener('resize', app.canvasResizeForwarder.bind(app));
	window.addEventListener('orientationchange', app.orientationChangeForwarder.bind(app));
}

function canvasResize(app) {
	var w = window.innerWidth;
	var h = window.innerHeight;

	app.renderer.renderer.resize(w, h);

	app.renderer.stage.scale.x = zoom*w/1600;
	app.renderer.stage.scale.y = -zoom*h/900;

	if(app.renderer.stage.scale.x > (-app.renderer.stage.scale.y))
		app.renderer.stage.scale.x = -app.renderer.stage.scale.y;
	else
		app.renderer.stage.scale.y = -app.renderer.stage.scale.x;

	renderUpdate(app);
}

function orientationChange(app) {
	window.scrollTo(0, 0);
	resize(app);
	window.scrollTo(0, 0);
	window.scrollTo(0, 0);
}


function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};


// save and load pretrained network
function setCopyLoadEvents(app) {
	window.addEventListener("copy", app.saveNetForwarder.bind(app));
	window.addEventListener("paste", app.loadNetForwarder.bind(app));
	parent.document.getElementById("pretrained").addEventListener("click", app.loadPretrainedNetForwarder.bind(app));
}

function saveNet(e, app) {
	e.preventDefault();

	const net = app.gen_algo.population[0].net.save();

	console.log(net);
	e.clipboardData.setData('text/plain', net);
}

function loadNet(e, app) {
	e.preventDefault();

	const net_obj = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));

	resetCars(app);

	app.gen_algo.population[0].net.load(net_obj);
	console.log("neural net restored");
}

function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":13,"hidden_layers":[{"inputs":13,"neurons":[{"weights":[1.1575835811318556,0.9202445118915275,0.6870112947075626,1.1489767487361202,-0.03249122443818066,0.8223352295065482,0.23627350269633068,-0.2224259076903503,1.2806608648128308,-0.6803546170431318,-0.9236388191846001,0.9012009345919558,-1.267460391053774],"bias":-0.21810561626642883},{"weights":[-1.8350847116511486,0.7244127649516241,0.4566600210526115,-0.03529996700490265,-0.5031428233883254,-0.035537307969558035,0.3834502697049837,0.1882449109492838,-0.6027472025229548,-0.442547285362476,-0.4117921735617079,-0.1489024828313964,0.7586557694065069],"bias":0.09730317159714166},{"weights":[0.6635489221767252,0.23445680858528972,-0.059384159004626645,0.043551997208255325,0.5259429862989109,-1.2372745408147536,0.6799548683325821,-0.1757166722259415,-0.38857239185010317,-0.058185869581920784,-0.547919753313107,0.819924941255395,1.3388957592790687],"bias":-0.3010919430113299},{"weights":[-0.43514974761762326,-0.09305844210019514,-0.42169315334585394,-1.119607342213543,-0.0680528047245586,-0.8540948533719549,1.3656507851531465,-0.7124512636435455,-1.0407318037251534,-0.09934229399576511,-0.34408698845398444,0.12288838185319144,0.022483605678029102],"bias":0.09590330988877749},{"weights":[-1.0158358111352899,-0.5068150811970589,-0.18187500060275785,0.22765312095116774,0.768432570447566,0.6746392157862122,-0.3228133737712822,-0.8033721841185109,-0.6529917404116523,-0.9406864249956363,-0.8083533878753613,-0.007432592175678668,-0.5870308896451412],"bias":-0.4157170304876625},{"weights":[0.48783632701095075,0.10127684270480077,0.5137401717438452,-0.3277695515997991,-1.1362973540449344,0.5520740625346336,0.17332951932087098,0.5951746826051959,-0.287544120238996,0.3139513431071228,-1.0906858349233393,-0.7925793155469617,0.24179776465478037],"bias":0.5165189691699896},{"weights":[0.3086554334136129,0.42172024440662415,0.3543154931995479,0.2161743127170851,0.1527211837718091,-0.17427055849382808,0.3687788863948807,-1.0321917925354307,1.2060862621829016,-1.1148915037354814,-0.8343420942236054,0.1934125479255042,0.7751249116722729],"bias":0.39129448013605916},{"weights":[-1.042083845614103,-0.15885651102250875,0.4240566798054186,-0.14273221231926908,0.8641776400508694,0.15137684177732444,-0.9128057932520066,0.050565158452213405,0.6902301477120097,1.1857453474267454,-0.22484335975622777,0.22332617988482062,0.21749778056900448],"bias":0.32534640826004124},{"weights":[-0.2226931151423773,0.7196440099739078,-0.6248524342455837,-0.4052846554129871,-0.22383434469795024,0.21857558145653316,-0.4183113811003194,-0.15429546048329465,-0.16276044471782894,1.088343118715603,1.106763644331188,0.632343359315414,0.02662943299975562],"bias":0.2429331215823337},{"weights":[-0.8928853163967074,0.3349588136812244,-0.13272640540503838,-0.18582047327966478,0.17293397778651565,-1.0105294534663014,1.0941643051410608,-0.18620956921986082,0.2728453095383646,-1.2672334973455603,0.8234450421935884,0.04978586238720184,0.34114106888838325],"bias":0.6327450471789995}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.5145298626634432,-0.6737211559391565,0.23707094391450012,0.09489826823386557,0.35221255773099625,-1.3174077766976973,-0.942262328895416,0.04174735807971821,0.839482519293561,0.4196592690406369],"bias":0.187660886476844},{"weights":[0.30165967323132337,0.7610132755068154,-1.1351342641696052,0.27138016640643886,-0.36326171933925655,0.12365073287484307,-0.8347661746480306,0.30186880799228505,0.5783272542284008,0.3319534497588724],"bias":0.23909166217594235},{"weights":[-0.9109641669492313,-1.0801531779181852,0.20327634922987073,-0.09948102694301862,-0.141068704826553,-0.43272781563502877,-0.18150172625462907,-1.183741952271754,-0.502999413513036,0.39628717244304296],"bias":0.055621123728856636},{"weights":[0.08162155822276351,-0.04558896984910371,0.8115109611413057,-0.28378334785315396,-0.29699245027430143,0.641962194979688,-0.7229702473388813,-1.3013286671677524,-0.5788247399746888,-0.6199031290416139],"bias":0.14195567058983158}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};