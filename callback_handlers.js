// simulation speed toggling
function initSpeedToggle(app) {
	app.renderer.renderer.view.addEventListener('mousedown', app.toggleSimSpeedForwarder.bind(app));
	app.renderer.renderer.view.addEventListener('touchstart', app.toggleSimSpeedForwarder.bind(app));
}

function toggleSimSpeed(app) {
	if (m_sim_intv_fps == 60) {
		m_sim_intv_fps = 1000;
		m_render_fps = 10;
	}
	else {
		m_sim_intv_fps = 60;
		m_render_fps = 30;
	}
	
	console.log("sim fps: " + m_sim_intv_fps)
	console.log("render fps: " + m_render_fps);

	setStepIntv(app);
	setAnimIntv(app);
}


// scroll wheel - zoom camera in and out
function setMouseZoomEvent(app) {
	app.renderer.renderer.view.addEventListener('wheel', function(event) {
		event.preventDefault();

		if((event.deltaX + event.deltaY + event.deltaZ) > 0) {
			if(zoom > 1)
				zoom -= 1;
		} else
			zoom += 1;

		canvasResize(app);
	});
}


// canvas resizing
function setResizeEvents(app) {
	window.addEventListener('resize', app.canvasResizeForwarder.bind(app));
	window.addEventListener('orientationchange', app.orientationChangeForwarder.bind(app));
}

function canvasResize(app) {
	var w = window.innerWidth;
	var h = window.innerHeight;

	app.renderer.renderer.resize(w, h);

	app.renderer.stage.scale.x = zoom*w/1600;
	app.renderer.stage.scale.y = -zoom*h/900;

	if(app.renderer.stage.scale.x > (-app.renderer.stage.scale.y))
		app.renderer.stage.scale.x = -app.renderer.stage.scale.y;
	else
		app.renderer.stage.scale.y = -app.renderer.stage.scale.x;

	renderUpdate(app);
}

function orientationChange(app) {
	window.scrollTo(0, 0);
	resize(app);
	window.scrollTo(0, 0);
	window.scrollTo(0, 0);
}


function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":12,"hidden_layers":[{"inputs":12,"neurons":[{"weights":[-0.28413118213989424,-0.26557951773823524,1.104276160486788,-0.8589548990581757,0.48991922436662483,-0.690222365325193,0.36652248075373695,0.39730477616493504,0.6918015866461084,1.0628397551835156,-0.4529675883541771,-0.6097750440404699],"bias":0.21459496682080662},{"weights":[0.6027373658285836,-0.30412478884945787,0.07262153934791085,-0.03944678324816374,0.8069227792923274,-0.3905847129018902,-0.8541663438768914,-1.1469363665875885,0.7170934011488,0.7464663141031873,0.5691079168866573,0.26376229518848726],"bias":0},{"weights":[-0.9639905702638478,0.32312199319296,-0.025782737304205758,0.5548446344741808,-0.1302494716551864,-0.11828736437630277,-0.47587614715071824,-0.07218505768089588,-0.6864022907123851,-0.21759925711659447,0.7178203964867654,-0.7038717348730472],"bias":-0.10094409707457619},{"weights":[0.0997732154013404,-0.00590372554375114,0.6269711953331479,0.8893010674985276,-0.07018185522994734,0.4249680118302581,-0.3765323522652454,-0.4724600914909404,-0.8013600750382222,0.19513592607806096,-0.1471455992011507,-0.37529304961166954],"bias":-0.3139309341272317},{"weights":[0.42394643126398224,-0.16825197244401557,0.3432154302026682,0.6628225957555238,-0.09470677871833957,-0.9841031407871266,0.5073430850214387,-0.5919513967729014,0.11198362247193906,0.7759129683053332,0.07090654489095138,0.034897615106578],"bias":0.17171205220653274},{"weights":[-0.9159753720891365,0.5304664491434828,-0.07709680147813554,-0.6591530998680288,0.2085162482489457,0.056787022027929374,-0.5276230194573965,-0.5203319138950415,0.11834499616819523,0.4755629991926412,-0.14659536228030093,-0.8357053141014177],"bias":0.03710169677194509},{"weights":[-0.4661728826847559,-0.012557010778356172,-0.5290020890429895,0.6694465971103127,0.5722078817254714,0.09470976828637882,0.4572257666715487,-0.9789958602592923,1.0845179564516234,-0.6774675674085299,0.256725143303481,0.9052521501663232],"bias":-0.305494060535614},{"weights":[0.7141861172002517,0.7686205379634558,-0.3510821375390428,0.7483868993798253,0.539073742342631,0.8928507184723085,0.2582473225178215,-0.9530409528590851,0.996421404163776,-0.36142183934078437,0.8330805500290472,-0.4109898441376658],"bias":-0.0705174094962996},{"weights":[-0.12617007973884903,-0.8109975078843159,0.5596263819930322,0.5219633051447675,-0.8892333536203441,-0.38136654201266,-0.8386103328611775,-0.44271308211525046,-0.5780697864811786,-0.22412668041463926,-0.3714911142517509,0.03797855816229758],"bias":-0.11025374204794085},{"weights":[0.3911789844969765,0.25083219678290947,0.21900428711625786,0.7174156414890929,-0.21078255659598755,0.24216995375606998,-0.3951867214451557,-0.798036982327093,0.18772883143643176,0.9587028100477961,0.3927647923007322,-0.8621974939389171],"bias":-0.012036221181522767}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.7530627545267151,0.34004393504179337,0.799211703217745,0.8574709737824384,0.6095436790407794,0.4656043879975161,-0.0549213721314219,-0.8631825631982207,0.4354930684609113,0.8248744652183063],"bias":-0.06917377782005064},{"weights":[1.032305985334006,-0.36641737125743074,-0.4693741622481235,0.9929647679183465,-0.07391433472952652,0.07055263563286394,-0.1470508367815206,-0.013399645165783437,0.54673714471659,-0.24662990716132333],"bias":-0.11488130267411228},{"weights":[-0.7326891906899162,-0.19989828823831068,-0.46486729202954463,-0.3185719980353725,0.8386073949269339,-0.9727273111664854,-0.6987544531184455,-0.7650487377296435,0.9001254261508083,0.4311303919975358],"bias":-0.028469936350350628},{"weights":[0.35724596044048174,-0.6005930133257734,0.7492985082081991,0.9232846626184497,-0.9545964004008525,-0.9964641322152803,-0.6217787046254284,-0.5294168234300058,1.0236607554070138,0.3047990238455073],"bias":0.19256076962343383}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};


// save and load pretrained network
function setCopyLoadEvents(app) {
	window.addEventListener("copy", app.saveNetForwarder.bind(app));
	window.addEventListener("paste", app.loadNetForwarder.bind(app));
	parent.document.getElementById("pretrained").addEventListener("click", app.loadPretrainedNetForwarder.bind(app));
}

function saveNet(e, app) {
	e.preventDefault();

	const net = app.gen_algo.population[0].net.save();

	console.log(net);
	e.clipboardData.setData('text/plain', net);
}

function loadNet(e, app) {
	e.preventDefault();

	const net_obj = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));

	resetCars(app);

	app.gen_algo.population[0].net.load(net_obj);
	console.log("neural net restored");
}

function loadPretrainedNet(e, app) {
	const net_obj = JSON.parse('{"inputs":13,"hidden_layers":[{"inputs":13,"neurons":[{"weights":[1.1819861268675889,0.7839678586924886,0.7313810356998521,1.079559972397274,0.16333276054164442,0.7657560275515142,0.15358284940198796,-0.21965262275472308,0.8260691482810614,-0.7992676989847313,-0.6769709614805487,0.8673966643685074,-1.0639398628272818],"bias":-0.3969154742294068},{"weights":[-1.2763898999954024,0.5396365846540363,0.37113836313644133,-0.07980515220749429,-0.30212173505596773,0.06635733854694104,0.5174449714130809,0.3703674158921846,-0.7288994222771585,-0.6472171871449068,-0.5650583353548017,0.03845897471810371,0.6805207015744308],"bias":-0.0878527422132316},{"weights":[0.6018449352533823,0.4505156927046615,-0.28677974905728715,-0.08505684516286076,0.6165049703661898,-1.337860390647128,0.5798594641284033,0.004539900402411305,-0.3534202836993249,0.05713170321388225,-0.8556245258022879,0.7908823648001934,1.2938962661430542],"bias":-0.4883062859899299},{"weights":[-0.5322728243434046,-0.05083519550247233,-0.39751406856781946,-0.9442097403796279,-0.0680528047245586,-0.6183377104152176,0.8608358327201545,-0.9493932263129813,-0.9671054357033778,-0.2206864614888077,-0.07322008942321438,-0.3367076668590102,0.13155705832358508],"bias":0.010642359566998293},{"weights":[-0.713340594391859,-0.5532623179487608,0.34680481029093524,0.10091446172846084,0.5951169188125603,0.5322908558300496,-0.3573494122963381,-0.6745994084401318,-0.6053801287162657,-0.8998974472389435,-0.714577680290281,0.017897348868580853,-0.540856661503635],"bias":-0.24213533146853064},{"weights":[0.38993153718590995,-0.034391490628176834,0.3902759411799791,-0.3353712001825473,-0.6818685236323494,0.4555882788228519,-0.05330582550657834,0.5488571681078529,-0.2745984853289719,0.5379774795986042,-0.8407548929112522,-0.7077243855497368,0.38578277824015955],"bias":0.23205079691551628},{"weights":[0.5623826431821441,0.5429310709159342,0.2995641181394003,0.04394437291733326,-0.17956475735241184,-0.22986198329487226,0.5836337236406305,-1.0731579476067807,1.1623219354166932,-0.9368927969055433,-0.6045234071859173,0.14298985334803338,0.708445034173996],"bias":0.19206071763826954},{"weights":[-0.976419073450263,-0.0884527330379011,0.4293743511139371,-0.2664614926702348,0.6112794919456024,0.2707769927571064,-0.695593789868025,-0.15167003178827576,0.7084624138518404,0.8151865321165539,-0.5154358810747683,0.09619802252103747,0.2712636458449593],"bias":0.052700826928316805},{"weights":[-0.2226931151423773,0.5052843402880012,-0.32090575442048264,-0.5309233450290766,-0.11850656105435363,0.40340915858819687,-0.17789012568223844,0.1293652199372374,-0.42005479418694824,0.8033783548451465,0.8671620295820052,0.7186635448759953,0.31731122879469814],"bias":0.0468367945452066},{"weights":[-0.7579680563997598,0.3860725119893338,-0.3662851207729871,-0.06572889855115949,0.13191535438332286,-0.8495983517375434,0.9250046103435521,-0.07908694878942371,0.19583446986346745,-1.2809713703435543,0.8442088018344426,0.07540863309967204,0.5054779742637249],"bias":0.4681978943460888}]}],"output_layer":{"inputs":10,"neurons":[{"weights":[0.45779058067077794,-0.6922027779165025,0.17648525581597663,0.1037125371667928,0.02588248838447305,-1.156413339320577,-0.8156691532971628,0.09925617140112271,0.685476307756239,0.1344774929324192],"bias":0.0329177898204812},{"weights":[0.5197751526494199,1.0967891148136026,-1.0999758592034599,0.2086310092026079,-0.6037610179653567,-0.062332150786788894,-0.7251143594327105,0.16946109008326143,0.6872792257346035,0.19034806233448331],"bias":0},{"weights":[-0.916004820578193,-1.1317294358464367,0.1797748419820101,0.09863856921373981,-0.12192073582737725,-0.4833422799145447,-0.14631800001452278,-1.2214123670592003,-0.27367648215788437,-0.07613912373952082],"bias":0.04302835052519057},{"weights":[0.23042739660991504,-0.093151797923259,0.496479431459351,-0.32747578331432814,-0.32832683270647595,0.6638638997747162,-0.6048334655474698,-1.3350165953171016,-0.6849965855414053,-0.704116461086994],"bias":0.18883551709760885}]}}');

	app.gen_algo.population[0].net.load(net_obj);

	resetCars(app);

	console.log("neural net restored");
};